
load('nashorn:mozilla_compat.js');
importPackage(java.lang);
importPackage(Packages.util);
importPackage(Packages.client.inventory);
importPackage(Packages.tools.packet);
importPackage(Packages.server);
importPackage(Packages.tools);
var status;


var icon1 = "#fEffect/ItemEff/004/0#"; //黃驚嘆
var icon5 = "#fEffect/ItemEff/0/10#";
var icon2 = "#fUI/UIWindow/Quest/icon1#"; //灰驚嘆
var icon3 = "#fEffect/ItemEff/004/1#";
var icon4 = "#fUI/UIWindow/Quest/icon7/8#"; //限時
var cake = "#fEffect/ItemEff/0/9#";
var get = "#fEffect/ItemEff/004/3#";
var need = "#fEffect/ItemEff/004/4#";



var item = [1003601,1102456,1082472,1052509,1072711,1132156,1152094,1302229,1312118,1322164,1402153,1412106,1422109,1432140,1442184,1003603,1102458,1082474,1052511,1072713,1132158,1152096,1372141,1382170,1003604,1102459,1082475,1052512,1072714,1132159,1152097,1332195,1342071,1362069,1472181,1003602,1102457,1082473,1052510,1072712,1132157,1152095,1452172,1462161,1522073,1003605,1102460,1082476,1052513,1072715,1132160,1152098,1482142,1492154,1532076,1022215,1382048,1382049,1382050,1382051,1032219,1113075,1003172,1052314,1072485,1082295,1102275,1152108,1302152,1312065,1322096,1402095,1412065,1422066,1432086,1442116,1003173,1052315,1072486,1082296,1102276,1152110,1372084,1382104,1003174,1052316,1072487,1082297,1102277,1152111,1452111,1462099,1522018,1003175,1052317,1072488,1082298,1102278,1152112,1332130,1342036,1472122,1003176,1052318,1072489,1082299,1102279,1152113,1482084,1492085,1532018,1802000,1802001,1802002,1802003,1802004,1802005,1802006,1802007,1802008,1802009,1802010,1802011,1802012,1802013,1802014,1802015,1802016,1802017,1802018,1802019,1802020,1802021,1802022,1802023,1802024,1802025,1802026,1802027,1802028,1802029,1802030,1802031,1802032,1802033,1802034,1802035,1802036,1802037,1802038,1802039,1802040,1802041,1802042,1802043,1802044,1802045,1802047,1802053,1802054,1802055,1802056,1802059,1802060,1802061,1802062,1802063,1802064,1802065,1802066,1802067,1802068,1802070,1802072,1802076,1802078,1802079,1802080,1802081,1802082,1802083,1802084,1802100,1802338,1802339,1802340,1802341,1802342,1802343,1802344,1802345,1802346,1802347,1802348,1802350,1802351,1802352,1802353,1802354,1802365,1802366,1802367,1802369,1802370,1802371,1802375,1802378,1802379,1802380,1802381,1802382,1802383,1802384,1802385,1802386,1802389,1802390,1802391,1802394,1802395,1802396,1802418,1802419,1802420,1802421,1802422,1802423,1802424,1802425,1802426,1802427,1802428,1802429,1802433,1802434,1802435,1802436,1802444,1802445,1802446,1802447,1802448,1802450,1802451,1802452,1802458,1802459,1802460,1802461,1802463,1802464,1802465,1802466,1802467,1802468,1802469,1802470,1802471,1802472,1802473,1802475,1802476,1802477,1802478,1802479,1802480,1802481,1802482,1802483,1802484,1802488,1802489,1802490,1802491,1802493,1802497,1802498,1802499,1802500,1802501,1802502,1802503,1802504,1802505,1802509,1802510,1802511,1802512,1802520,1802521,1802522,1802524,1802526,1802527,1802528,1802529,1802530,1802531,1802532,1802534,1802535,1802536,1802539,1802540,1802541,1802542,1802543,1802544,1802545,1802548,1802549,1802550,1802551,1802553,1802554,1802555,1802556,1802557,1802558,1802559,1802560,1802561,1802562,1802563,1802564,1802565,1802566,1802567,1802568,1802569,1802570,1802571,1802572,1802573,1802574,1802575,1802576,1802577,1802578,1802579,1802580,1802581,1802582,1802583,1802584,1802585,1802586,1802587,1802588,1802589,1802590,1802591,1802592,1802593,1802594,1802595,1802596,1802597,1802598,1802599,1802600,1802601,1802602,1802603,1802604,1802605,1802606,1802607,1802608,1802609,1802610,1802611,1802613,1802614,1802615,1802616,1802617,1802618,1802619,1802620,1802621,1802622,1802623,1802624,1802625,1802626,1802627,1802629,1802630,1802631,1802632,1802633,1802634,1802635,1802638,1802639,1802640,1802641,1802642,1802643,1802644,1802645,1802646,1802647,1802648,1802649,1802650,1802651,1802652,1802653,1802654,1802655,1802656,1802657,1802658,1802659,1802660,1802661,1802662,1802663,1802664,1802665,1802666,1802667,1802668,1802669,1802671,1802672,1802673,1802674,1802675,1802676,1802677,1802680,1802681,1802682,1802683,1802684,1802685,1802686,1802687,1802688,1802689,1802690,1802692,1802693,1802694,1802695,1802696,1802697,1802698,1802700,1802701,1802702,1802703,1802704,1802705,1802706,1802707,1802708,1802709,1802710,1802711,1802712,1802713,1802714,1802715,1802716,1802717,1802718,1802719,1802720,1802721,1802722,1802723,1802724,1802725,1802726,1802727,1802731,1802732,1802733,1802734,1802735,1802736,1802738,1802739,1802740,1802741,1802742,1802743,1802744,1802746,1802747,1802748,1802749,1802750,1802751,1802757,1802758,1802759,1802761,1802762,1802763,1802764,1672082,1004422,1102775,1082636,1052882,1073030,1152174,1302333,1312199,1322250,1402251,1412177,1422184,1432214,1442268,1004423,1102794,1082637,1052887,1073032,1152176,1372222,1382259,1004424,1102795,1082638,1052888,1073033,1152177,1452252,1462239,1522138,1004425,1102796,1082639,1052889,1073034,1152178,1332274,1472261,1342101,1004426,1102797,1082640,1052890,1073035,1152179,1482216, 1492231,1532144,1143029,1143174,1113231,1032223,1122267,1132246,];

var extra = [1004425,1004422,1102775,1082636,1052882,1073030,1152174,1302333,1312199,1322250,1402251,1412177,1422184,1432214,1442268,1004423,1102794,1082637,1052887,1073032,1152176,1372222,1382259,1004424,1102795,1082638,1052888,1073033,1152177,1452252,1462239,1522138,1004425,1102796,1082639,1052889,1073034,1152178,1332274,1472261,1342101,1004426,1102797,1082640,1052890,1073035,1152179,1482216, 1492231,1532144];

var cost = 5640005;
var extracost = 5640008;


var limit = 10;
var extralimit = 20;




function start(){
	status = -1;
	action(1,0,0);
}




function action(mode, type, selection) {
    if (mode == 1) {
        status++;
    } else {
        status--;
    }
	if(mode == 0){
		cm.dispose();
	}
	
    if (status == 0) {
		var msg = "";
		msg += icon5 + " #e#d【裝備強化系統】#k\r\n" + icon1 + " #r需消耗一個 :#k #b#z" + cost + "# #r或#k#b #z" + extracost + "##k\r\n";
		msg += "#L0#" + icon3 + " #b查看強化規則#k\r\n";
		msg += "#L2#" + icon3 + " #b查看強化清單#k\r\n";
		msg += "#L1#" + icon3 + " #b我要強化裝備#k\r\n";
        cm.sendSimple(msg);		
	}else if(status == 1){
		this. s = selection;
		if(s < 0){
			cm.dispose();			
		}else if(s == 0){
			var msg = "#e";
			msg += icon5 + " #b強化規則簡介#k\r\n";
			msg += icon3 + " #d此強化系統僅強化清單之裝備，且必強化成功#k\r\n";
			msg += icon3 + " #d超強化清單內的物品也包含在強化清單內#k\r\n";
			msg += icon3 + " #d每次強化使裝備卷軸數提升#k #r1次#k #d全屬/AD/AP#k #r+3#k\r\n";
			msg += icon3 + " #d每個裝備強化次數上限為#k #r" + limit + "次#k\r\n";
			msg += icon3 + " #d每個裝備超強化次數上限至#k #r" + extralimit + "次#k\r\n";
			msg += icon3 + " #d裝備完成10次強化後方可使用超強化#k\r\n";
			msg += icon3 + " #d強化時請將欲強化裝備放置裝備欄第一格#k\r\n";
			msg += icon3 + " #d每次強化皆需消耗一灌#k #r#z" + cost + "##k\r\n";
			msg += icon3 + " #d每次超強化皆需消耗一灌#k #r#z" + extracost + "##k\r\n";
			cm.sendOk(msg);
			status = -1;
		}else if(s == 1){
			var eq = cm.getInventory(1).getItem(1);
		    if(eq != null){
		        var upgrade = eq.getSocket1() == -1 ? 0 : eq.getSocket1();
		    }
			if(eq == null){
				cm.sendOk("#d請確認裝備欄第一格有裝備#k");
				status = -1;
			}else if(item.indexOf(eq.getItemId()) == -1 && extra.indexOf(eq.getItemId()) == -1){
				cm.sendOk("#d您的裝備欄第一格裝備 :#k #r#t" + eq.getItemId() + "##k #d並不在強化或超強化清單#k");
				status = -1;
			}else if(upgrade >= limit && extra.indexOf(eq.getItemId()) == -1){
				cm.sendOk("#d您的裝備欄第一格裝備 :#k #r#t" + eq.getItemId() + "##k #d已完成" + limit + "次強化#k #d且裝備並不在超強化清單中");
				status = -1;
			}else if(upgrade >= extralimit){
				cm.sendOk("#d您的裝備欄第一格裝備 :#k #r#t" + eq.getItemId() + "##k #d已完成" + extralimit + "次強化#k");
				status = -1;
			}else{
				var msg = "#e";
				msg += icon5 + " #b強化確認頁面#k\r\n";
				msg += icon3 + " #d欲強化裝備 :#k #r#z" + eq.getItemId() + "##k\r\n";
				msg += icon3 + " #d當前已強化次數 :#k #r" + upgrade + "#k\r\n";
				msg += icon1 + " #b是否確認要強化此裝備?#k\r\n";
				cm.sendYesNo(msg);
			}
		}else if(s == 2){
			var msg = "#e#b以下為可強化之裝備 :\r\n\r\n";
			for(var i = 0; i < item.length ; i++){
				msg += "#i" + item[i] + "#";
			}
			
			msg += "\r\n#r以下為可超強化之裝備 :\r\n\r\n";
			for(var j = 0; j < extra.length ; j++){
				msg += "#i" + extra[j] + "#";
			}
			cm.sendOk(msg);
            status = -1;
		}
	}else if(status == 2){
		var eq = cm.getInventory(1).getItem(1);
		if(eq != null){
		    var upgrade = eq.getSocket1() == -1 ? 0 : eq.getSocket1();
		}
		
		
		var costItem = upgrade >= 10 ? extracost : cost;
		
		if(cm.getPlayer().getItemQuantity(costItem,false) < 1){
			cm.sendOk("#d您的身上並沒有#k #r#z" + costItem + "##k");
			status = -1;
		}else{
			eq.setSocket1(upgrade + 1);
			eq.setStr(eq.getStr() + 3);
			eq.setDex(eq.getDex() + 3);
			eq.setInt(eq.getInt() + 3);
			eq.setLuk(eq.getLuk() + 3);
			eq.setWatk(eq.getWatk() + 3);
			eq.setMatk(eq.getMatk() + 3);
			eq.setUpgradeSlots(eq.getUpgradeSlots() + 1);
			cm.getPlayer().forceReAddItem_NoUpdate(eq, MapleInventoryType.EQUIP);
			cm.getPlayer().getClient().sendPacket(CWvsContext.InventoryPacket.updateSpecialItemUse(eq, MapleInventoryType.EQUIP.getType(), eq.getPosition(), true, cm.getPlayer()));
			cm.gainItem(costItem,-1);
			cm.sendOk("#d恭喜您,強化完成#k");
			status = -1;
		}
	}
	
}

		